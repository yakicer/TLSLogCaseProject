@using Contracts.DTO.Dashboard
@model DashboardResponse
@{
    ViewData["Title"] = "Dashboard";
    var summary = Model?.Summary ?? new SummaryCardsDto();
    var sales = Model?.SalesLast12 ?? new List<MonthlySalesPoint>();
    var orders7 = Model?.OrdersLast7 ?? new List<WeeklyOrdersPoint>();
    var status = Model?.OrdersByStatus ?? new OrdersByStatusDto();
    var topCustomers = Model?.TopCustomers ?? new List<TopCustomerItem>();
    var topStocks = Model?.TopStocks ?? new List<TopStockItem>();
    var byCity = Model?.OrdersByCity ?? new List<OrdersByCityItem>();
}

<link href="~/simple-admin/assets/vendor/fontawesome/css/fontawesome.min.css" rel="stylesheet" />
<link href="~/simple-admin/assets/vendor/fontawesome/css/solid.min.css" rel="stylesheet" />

<div class="container-fluid py-3">

    <!-- Loader -->
    <div id="dashboard-loader" class="d-flex justify-content-center align-items-center" style="min-height: 200px;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Yükleniyor...</span>
        </div>
    </div>
    <div id="dashboard-content" class="d-none">

        @if (TempData["Error"] != null)
        {
            <div class="alert alert-danger">@TempData["Error"]</div>
        }

        <div class="row g-3">
            <div class="col-sm-6 col-lg-3">
                <div class="card h-100">
                    <div class="card-body d-flex">
                        <div class="me-3 d-flex align-items-center">
                            <i class="fas fa-shopping-cart text-info fs-2"></i>
                        </div>
                        <div>
                            <div class="text-muted small">Bu Hafta Yeni Sipariş</div>
                            <div class="fs-4 fw-bold">@summary.NewOrdersThisWeek</div>
                            <div class="small text-muted"><i class="fas fa-calendar"></i> Bu hafta</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-sm-6 col-lg-3">
                <div class="card h-100">
                    <div class="card-body d-flex">
                        <div class="me-3 d-flex align-items-center">
                            <i class="fas fa-money-bill-alt text-success fs-2"></i>
                        </div>
                        <div>
                            <div class="text-muted small">Aylık Ciro</div>
                            <div class="fs-4 fw-bold">₺ @summary.RevenueThisMonth.ToString("N2")</div>
                            <div class="small text-muted"><i class="fas fa-calendar"></i> Bu ay</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-sm-6 col-lg-3">
                <div class="card h-100">
                    <div class="card-body d-flex">
                        <div class="me-3 d-flex align-items-center">
                            <i class="fas fa-receipt text-primary fs-2"></i>
                        </div>
                        <div>
                            <div class="text-muted small">Aylık Sipariş</div>
                            <div class="fs-4 fw-bold">@summary.OrdersThisMonth</div>
                            <div class="small text-muted">Ort. Sepet: ₺ @summary.AvgOrderValueThisMonth.ToString("N2")</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-sm-6 col-lg-3">
                <div class="card h-100">
                    <div class="card-body d-flex">
                        <div class="me-3 d-flex align-items-center">
                            <i class="fas fa-users text-warning fs-2"></i>
                        </div>
                        <div>
                            <div class="text-muted small">Aktif Müşteri / Stok</div>
                            <div class="fs-4 fw-bold">@summary.ActiveCustomers / @summary.ActiveStocks</div>
                            <div class="small text-muted">Sistem Özeti</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-3 mt-1">
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0">Son 12 Ay Ciro</h6>
                            <small class="text-muted">Vergiler Dahil</small>
                        </div>
                        <canvas id="sales12"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0">Son 7 Gün Sipariş</h6>
                            <small class="text-muted">Adet</small>
                        </div>
                        <canvas id="orders7"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-3 mt-1">
            <div class="col-lg-4">
                <div class="card h-100">
                    <div class="card-body">
                        <h6 class="mb-3">Sipariş Durumları</h6>
                        <canvas id="statusPie"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card h-100">
                    <div class="card-body">
                        <h6 class="mb-3">En Çok Ciro Yapan Müşteriler (90g)</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-striped">
                                <thead>
                                    <tr><th>Müşteri</th><th class="text-end">Ciro</th><th class="text-end">Sipariş</th></tr>
                                </thead>
                                <tbody>
                                    @foreach (var c in topCustomers)
                                    {
                                        <tr>
                                            <td>@c.CustomerName</td>
                                            <td class="text-end">₺ @c.Revenue.ToString("N2")</td>
                                            <td class="text-end">@c.Orders</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card h-100">
                    <div class="card-body">
                        <h6 class="mb-3">En Çok Satan Ürünler (90g)</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-striped">
                                <thead>
                                    <tr><th>Stok</th><th class="text-end">Adet</th><th class="text-end">Ciro</th></tr>
                                </thead>
                                <tbody>
                                    @foreach (var s in topStocks)
                                    {
                                        <tr>
                                            <td>@s.StockName</td>
                                            <td class="text-end">@s.QuantitySold</td>
                                            <td class="text-end">₺ @s.Revenue.ToString("N2")</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-3 mt-1">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h6 class="mb-3">Şehre Göre Sipariş (90g)</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-striped">
                                <thead><tr><th>Şehir</th><th class="text-end">Sipariş</th></tr></thead>
                                <tbody>
                                    @foreach (var ci in byCity)
                                    {
                                        <tr>
                                            <td>@ci.City</td>
                                            <td class="text-end">@ci.OrderCount</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

</div>

@section Scripts {
    <script src="~/simple-admin/assets/vendor/chartsjs/Chart.min.js"></script>
    <script>
        (function () {
            const jsSales = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(sales));
            const labels12 = jsSales.map(x => x.Month);
            const data12 = jsSales.map(x => x.Revenue);

            new Chart(document.getElementById('sales12').getContext('2d'), {
                type: 'line',
                data: { labels: labels12, datasets: [{ label: 'Ciro (₺)', data: data12, fill: true, tension: .3, borderColor: '#17a2b8', backgroundColor: 'rgba(23, 162, 184, 0.2)' }] },
                options: {
                    responsive: true,
                    plugins: { legend: { display: true } },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            const jsOrders7 = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(orders7));
            const lbl7 = jsOrders7.map(x => x.Day);
            const cnt7 = jsOrders7.map(x => x.Count);

            new Chart(document.getElementById('orders7').getContext('2d'), {
                type: 'bar',
                data: { labels: lbl7, datasets: [{ label: 'Sipariş', data: cnt7, backgroundColor: '#007bff' }] },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });

            const jsStatus = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(status));
            const stLabels = ['İptal', 'Teslim', 'İşlemde', 'Teslimatta', 'İade'];
            const stData = [
                jsStatus.Cancelled ?? 0,
                jsStatus.Delivered ?? 0,
                jsStatus.InProgress ?? 0,
                jsStatus.OnDelivery ?? 0,
                jsStatus.Returned ?? 0
            ];

            const statusColors = ['#dc3545', '#28a745', '#ffc107', '#007bff', '#6c757d'];

            new Chart(document.getElementById('statusPie').getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: stLabels,
                    datasets: [{
                        data: stData,
                        backgroundColor: statusColors,
                        hoverBackgroundColor: statusColors
                    }]
                },
                options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
            });

            //olasi gecikmeler icin bir loader ornegi
            const loader = document.getElementById('dashboard-loader');
            const content = document.getElementById('dashboard-content');

            if (loader) loader.classList.add('d-none');
            if (content) content.classList.remove('d-none');
        })();
    </script>
}