@{
    ViewData["Title"] = "Stok Yönetimi";
}

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="mb-0">Stok Yönetimi</h3>
        <div class="d-flex align-items-center">
            <button class="btn btn-primary" id="btnAdd">+ Yeni Stok</button>
            <div class="form-check form-switch form-check-inline ms-3">
                <input class="form-check-input" type="checkbox" id="chkActives" checked>
                <label class="form-check-label" for="chkActives">Sadece aktifleri getir</label>
            </div>
        </div>
    </div>

    <div class="row g-3">
        <div class="col-lg-8">
            <div id="grid"></div>
        </div>
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header d-flex align-items-center justify-content-between">
                    <strong>Bu ürünü alan müşteriler</strong>
                    <span class="text-muted small" id="buyersHint">Lütfen tablodan stok seçiniz</span>
                </div>
                <div class="card-body p-2">
                    <div class="table-responsive">
                        <table class="table table-sm table-striped mb-0">
                            <thead>
                                <tr>
                                    <th style="width:80px; font-size:14px"> Müşteri ID</th>
                                    <th style="font-size:14px">Müşteri</th>
                                    <th style="width:40%;font-size:14px">Aktif Adres</th>
                                </tr>
                            </thead>
                            <tbody id="buyersTableBody">
                                <tr><td colspan="3" class="text-center text-muted py-3">Seçim bekleniyor</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer text-muted small">Aktif sipariş detaylarına göre listelenir.</div>
            </div>
        </div>
    </div>
</div>

<!-- Create/Update Modal -->
<div class="modal fade" id="stockModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <form id="stockForm" class="modal-content">
            @Html.AntiForgeryToken()
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Yeni Stok</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <input type="hidden" id="Id" name="Id" value="0" />
                <div class="mb-3">
                    <label class="form-label">Stok Adı</label>
                    <input class="form-control" id="StockName" name="StockName" required />
                </div>
                <div class="mb-3">
                    <label class="form-label">Birim</label>
                    <input class="form-control" id="Unit" name="Unit" placeholder="adet, kg, paket..." />
                </div>
                <div class="mb-3">
                    <label class="form-label">Fiyat</label>
                    <input type="number" step="0.01" class="form-control" id="Price" name="Price" value="0" />
                </div>
                <div class="mb-3">
                    <label class="form-label">Barkod</label>
                    <input class="form-control" id="Barcode" name="Barcode" required />
                </div>
                <div class="form-check form-switch">
                    <input class="form-check-input" id="IsActive" name="IsActive" type="checkbox" checked>
                    <label class="form-check-label" for="IsActive">Aktiflik</label>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">İptal</button>
                <button class="btn btn-primary" type="submit" id="btnSave">Kaydet</button>
            </div>
        </form>
    </div>
</div>
<!-- Delete Confirm -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title text-danger"><i class="bi bi-exclamation-triangle me-2"></i> Stoğu Sil</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Bu stoğu silmek istediğinize emin misiniz?
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Vazgeç</button>
                <button type="button" class="btn btn-danger" id="btnConfirmDelete">Evet, Sil</button>
            </div>
        </div>
    </div>
</div>

<script>
    let grid, modal, mdDelete, pendingDeleteId, isEdit = false;
    let selectedStockId = null;

    $(function () {
        modal = new bootstrap.Modal(document.getElementById('stockModal'));
        mdDelete = new bootstrap.Modal('#confirmDeleteModal');
        loadGrid();

        $('#btnAdd').on('click', openCreate);
        $('#chkActives').on('change', () => grid.refresh());

        $('#stockForm').on('submit', function (e) {
            e.preventDefault();
            const token = $('input[name="__RequestVerificationToken"]').val();
            const payload = collectForm();
            const url = isEdit ? '@Url.Action("Update")' : '@Url.Action("Create")';

            $.ajax({ url, method: 'POST', headers: { 'RequestVerificationToken': token }, data: payload })
                .done(res => {
                    if (res.success) { modal.hide(); grid.refresh(); DevExpress.ui.notify(res.message || 'Başarılı', 'success', 2000); }
                    else { DevExpress.ui.notify(res.message || 'Hata', 'error', 3000); }
                })
                .fail(() => DevExpress.ui.notify('Sunucu hatası', 'error', 3000));
        });

    });

    //delete modali
    $('#btnConfirmDelete').on('click', function () {
        if (!pendingDeleteId) return;
        const token = $('input[name="__RequestVerificationToken"]').val();
        $.ajax({
            url: '@Url.Action("Delete")',
            method: 'POST',
            headers: { 'RequestVerificationToken': token },
            data: { id: pendingDeleteId }
        }).done(res => {
            mdDelete.hide(); pendingDeleteId = null;
            if (res.success) { grid.refresh(); DevExpress.ui.notify(res.message || 'Silindi', 'success', 2000); }
            else { DevExpress.ui.notify(res.message || 'Silme hatası', 'error', 3000); }
        }).fail(() => DevExpress.ui.notify('Sunucu hatası', 'error', 3000));
    });
       
    //grid yukle (yablo yani)
    function loadGrid() {
        grid = $("#grid").dxDataGrid({
            height: 600, showBorders: true, columnAutoWidth: true, keyExpr: 'id',
            dataSource: new DevExpress.data.CustomStore({
                key: 'id',
                load: function () {
                    const onlyActives = $('#chkActives').is(':checked');
                    return $.getJSON('@Url.Action("List")', { onlyActives }).then(resp => {
                        if (!resp.success) { DevExpress.ui.notify(resp.message || 'Load error', 'error', 3000); return []; }
                        return resp.data;
                    });
                }
            }),
            columns: [
                { dataField: 'id', caption: 'ID', width: 70 },
                { dataField: 'stockName', caption: 'Stok Adı' },
                { dataField: 'barcode', caption: 'Barkod', width: 160 },
                { dataField: 'unit', caption: 'Birim', width: 120 },
                { dataField: 'price', caption: 'Fiyat', dataType: 'number', format: { type: 'fixedPoint', precision: 2 }, width: 120 },
                {
                    dataField: "isActive",
                    caption: "Aktiflik Durumu",
                    width: 120,
                    alignment: "center",
                    dataType: "boolean",
                    cellTemplate: function (cellElement, cellInfo) {
                        const isActive = cellInfo.value;

                        let badgeClass;
                        let badgeText;

                        if (isActive) {
                            badgeClass = 'bg-success';
                            badgeText = 'Aktif';
                        } else {
                            badgeClass = 'bg-danger';
                            badgeText = 'Pasif';
                        }
                        $('<span>')
                            .addClass('badge ' + badgeClass)
                            .text(badgeText)
                            .appendTo(cellElement);
                    }
                },
                {
                    caption: 'İşlemler',
                    width: 100,
                    alignment: 'center',
                    cellTemplate: function (container, options) {
                        const delBtn = $('<button>')
                            .addClass('btn btn-sm btn-danger custom-delete-btn')
                            .html('<i class="fa fa-trash me-1"></i> Sil')
                            .on('click', function () {
                                pendingDeleteId = options.data.id;
                                mdDelete.show();
                            });

                        $(container).append(delBtn);
                    }
                }
            ],
            paging: { pageSize: 10 }, pager: { showInfo: true },
            hoverStateEnabled: true, selection: { mode: 'single' },

            // seçilen stok için “müşteriler” panelini doldur
            onSelectionChanged: function (e) {
                const row = e.selectedRowsData?.[0];
                selectedStockId = row?.id || null;
                selectedStockName = row?.stockName || null;
                loadCustomersByStock(selectedStockId, selectedStockName);
            },

            onRowDblClick: function (e) {
                $.getJSON('@Url.Action("Detail")', { id: e.data.id }).done(resp => {
                    if (!resp.success) { DevExpress.ui.notify(resp.message || 'Bulunamadı', 'error', 3000); return; }
                    openEdit(resp.data);
                });
            },

            toolbar: { items: ["searchPanel"] },
            searchPanel: { visible: true, width: 240, placeholder: 'Ara...' }
        }).dxDataGrid("instance");
    }

    function openCreate() {
        isEdit = false;
        $('#modalTitle').text('Yeni Stok');
        $('#Id').val(0);
        $('#StockName').val('');
        $('#Unit').val('');
        $('#Price').val('0');
        $('#Barcode').val('');
        $('#IsActive').prop('checked', true);
        modal.show();
    }

    function openEdit(d) {
        isEdit = true;
        $('#modalTitle').text('Stok Düzenle');
        $('#Id').val(d.id);
        $('#StockName').val(d.stockName);
        $('#Unit').val(d.unit || '');
        $('#Price').val(d.price ?? 0);
        $('#Barcode').val(d.barcode || '');
        $('#IsActive').prop('checked', !!d.isActive);
        modal.show();
    }

    function collectForm() {
        return {
            Id: Number($('#Id').val() || 0),
            StockName: $('#StockName').val(),
            Unit: $('#Unit').val(),
            Price: parseFloat($('#Price').val() || '0'),
            Barcode: $('#Barcode').val(),
            IsActive: $('#IsActive').is(':checked')
        };
    }

    //stoklara gore musteri cekme kismi
    function loadCustomersByStock(stockId,stockName) {
        const $tbody = $('#buyersTableBody');
        if (!stockId) {
            $tbody.html('<tr><td colspan="3" class="text-center text-muted py-3">Seçim bekleniyor</td></tr>');
            $('#buyersHint').text('Lütfen tablodan stok seçiniz');
            return;
        }

        $('#buyersHint').text('#' + stockName);

        $.getJSON('@Url.Action("GetCustomersByStock")', { stockId }).done(resp => {
            if (!resp.success || !resp.data || resp.data.length === 0) {
                $tbody.html('<tr><td colspan="3" class="text-center text-muted py-3">Kayıt bulunamadı</td></tr>');
                return;
            }

            const rows = resp.data.map(c => {
                const adr = (c.addresses && c.addresses.length)
                    ? (c.addresses[0].address + ' ' + (c.addresses[0].city || '') + '/' + (c.addresses[0].town || ''))
                    : '';
                return `<tr>
                              <td style="font-size:14px">${c.id}</td>
                              <td style="font-size:14px">${c.customerName || ''}</td>
                              <td style="font-size:14px">${adr}</td>
                        </tr>`;
            }).join('');
            $tbody.html(rows);
        }).fail(() => {
            $tbody.html('<tr><td colspan="3" class="text-center text-danger py-3">Sunucu hatası</td></tr>');
        });
    }
</script>
