@using Web.Blazor.Models
@using Web.Blazor.Models.Enums
@using Web.Blazor.Models.RequestModel
@using Web.Blazor.Services.ApiServices
@using Web.Blazor.Services.Interface
@inject ISolutionService SolutionService
@inject DialogService DialogService
@inject IToastService ToastService
@inject IFileUploadService FileUploadService
@inherits BaseComponent


<RadzenTemplateForm Data="@solutionModel" TItem="SolutionRequestModel" onclose="@( () => SetDefaults )" Submit="@(() => HandleSubmit(solutionId))" InvalidSubmit=@OnInvalidSubmit>
    <div class="grid gap-3 p-3">
        <RadzenStack>
            <RadzenFormField Text="Çözüm Adı">
                <ChildContent>
                    <RadzenTextBox Change="@( () => isFormChanged = true)" Name="Title" @bind-Value="solutionModel.Title" />
                </ChildContent>
                <Helper>
                    <RadzenRequiredValidator Component="Title" Text="Çözüm Adı alanı zorunludur." />
                </Helper>
            </RadzenFormField>
            <RadzenFormField Text="Çözüm Açıklaması">
                <ChildContent>
                    <RadzenTextArea Rows="4" Change="@( () => isFormChanged = true)" Name="SubTitle" @bind-Value="solutionModel.SubTitle" />
                </ChildContent>
                <Helper>
                    <RadzenRequiredValidator Component="SubTitle" Text="Çözüm Açıklaması alanı zorunludur." />
                </Helper>
            </RadzenFormField>
            <RadzenFormField Text="Çözüm Türü">
                <RadzenDropDown Change="@( () => isFormChanged = true)" Name="SolutionType" @bind-Value="solutionModel.SolutionType" Data="@(Enum.GetValues(typeof(SolutionTypes)).Cast<Enum>())" />
            </RadzenFormField>
        </RadzenStack>
        <hr />
        <RadzenStack Orientation="Orientation.Vertical" Gap="0">
            <div class="py-2">
                <label for="select-mainfile-hidden" class="rz-button rz-button-md rz-variant-filled rz-base rz-shade-default align-self-center">
                    @if (mainImageBusy)
                    {
                        <i style="animation: rotation 700ms linear infinite" class="notranslate rzi" id="d4DUbQirfE" _bl_2837=""><!--!-->refresh</i>
                        <span>&nbsp;YÜKLENİYOR...</span>
                    }
                    else
                    {
                        <i class="notranslate rz-button-icon-left rzi"><!--!-->@uploadIcon</i>
                        <span>&nbsp;@selectedFile</span>
                    }
                </label>
                <InputFile hidden id="select-mainfile-hidden" OnChange="OnMainImageChange" disabled="@mainImageBusy" accept="image/*" />
            </div>
            @if (!string.IsNullOrEmpty(ThumbImagePath))
            {
                <RadzenStack Orientation="Orientation.Vertical" Gap="2">
                    <RadzenCard Variant="Variant.Outlined" Style="text-align:center;" class="rz-background-color-base-200 p-2 m-0">
                        <RadzenText TextStyle="TextStyle.Body1">
                            Çözüm ana görseli
                        </RadzenText>
                    </RadzenCard>
                    <RadzenCard Variant="Variant.Outlined">
                        <div class="d-flex flew-row align-self-center justify-content-center">
                            <RadzenRow RowGap="3">
                                <div class="position-relative">
                                    <img src="@( baseUrl + ThumbImagePath)" class="project_thumb_image mx-auto d-block" />
                                    <RadzenButton Click=@(() => RemoveMainImage()) Icon="delete" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small" class="rz-border-radius-10 rz-shadow-6 p-0 position-absolute top-0 end-0" />
                                </div>
                            </RadzenRow>
                        </div>
                    </RadzenCard>
                </RadzenStack>
            }
            @if (mainImage.LoadedFile != null && !string.IsNullOrEmpty(mainImage.LoadedFile?.Base64Content))
            {
                <RadzenStack Orientation="Orientation.Vertical" Gap="2">
                    <RadzenCard Variant="Variant.Outlined" Style="text-align:center;" class="rz-background-color-base-200 p-2 m-0">
                        <RadzenText TextStyle="TextStyle.Body1">
                            Seçili görsel
                        </RadzenText>
                    </RadzenCard>
                    <RadzenCard Variant="Variant.Outlined">
                        <div class="d-flex flew-row align-self-center justify-content-center">
                            <RadzenRow RowGap="3">
                                <div class="position-relative">
                                    <img src="@mainImage.LoadedFile?.Base64Content" class="project_thumb_image mx-auto d-block" />
                                    <RadzenButton Click=@(() => RemoveMainImage()) Icon="delete" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small" class="rz-border-radius-10 rz-shadow-6 p-0 position-absolute top-0 end-0" />
                                </div>
                            </RadzenRow>
                        </div>
                    </RadzenCard>
                    <RadzenCard Variant="Variant.Outlined" Style="text-align:center;" class="rz-background-color-base-200 p-2 m-0">
                        <RadzenText TextStyle="TextStyle.Body1">
                            Toplam Boyut : <b>@((mainImage.FileContent.Length / (1024 * 1024.0d)).ToString("0.##")) Mb</b>
                        </RadzenText>
                    </RadzenCard>
                </RadzenStack>
            }
        </RadzenStack>
        <RadzenButton class="mt-3" ButtonType="ButtonType.Submit" Text="Kaydet" />
    </div>
</RadzenTemplateForm>


@code {

    [Parameter] public SolutionModel? ExistingSolution { get; set; }

    private string selectedFile = "ANA GÖRSEL SEÇİNİZ";
    UploadFileModel mainImage = new();
    string uploadIcon = "upload";
    private bool isEdit => ExistingSolution != null;
    private bool canEditMainImage = false;
    private string? MainImagePath = string.Empty;
    private string? ThumbImagePath = string.Empty;
    private bool ShowMainImageUpload = false;
    bool mainImageBusy = false;
    private bool isLoading = false;
    private Guid solutionId = Guid.Empty;
    private bool isFormChanged = false;
    private SolutionRequestModel solutionModel = new();
    private string baseUrl = string.Empty;

    protected override void OnInitialized()
    {
        baseUrl = base.SetBaseUrl();
        SetDefaults();

        if (isEdit)
        {
            isFormChanged = false;
            solutionModel = new SolutionRequestModel
                {
                    Title = ExistingSolution!.Title,
                    SubTitle = ExistingSolution.SubTitle,
                    SolutionType = ExistingSolution.SolutionType,
                };
            solutionId = ExistingSolution.Id;
            MainImagePath = ExistingSolution.ImagePath;
            ThumbImagePath = ExistingSolution.ThumbImagePath;
            if (!string.IsNullOrEmpty(ExistingSolution.ThumbImagePath))
            {
                selectedFile = $"DEĞİŞTİR";
                uploadIcon = "cached";
                solutionModel.IsImageDeleted = false;
            }
        }
    }

    private async Task OnMainImageChange(InputFileChangeEventArgs e)
    {
        mainImageBusy = true;
        isFormChanged = true;
        if (isEdit && !canEditMainImage)
        {
            MainImagePath = string.Empty;
            ThumbImagePath = string.Empty;
            canEditMainImage = true;
            solutionModel.IsImageDeleted = true;
        }
        else
            mainImage = new();

        var file = e.GetMultipleFiles().FirstOrDefault();
        if (file != null)
        {
            try
            {
                var result = await FileUploadService.UploadFile(file);

                if (result != null)
                {
                    mainImage = result;
                    selectedFile = $"DEĞİŞTİR";
                    uploadIcon = "cached";
                    solutionModel.IsImageDeleted = false;
                }

            }
            catch (Exception ex)
            {
                ToastService.ShowError($"Dosya yüklenirken bir hata oluştu: {ex.Message}");
                mainImageBusy = false;
                solutionModel.IsImageDeleted = false;
            }
            mainImageBusy = false;
        }
        else
        {
            ToastService.ShowError($"Dosya yüklenirken bir hata oluştu. Lütfen dosyayı kontrol edip tekrar deneyiniz.");
            mainImageBusy = false;
            solutionModel.IsImageDeleted = false;
        }
    }

    private void RemoveMainImage()
    {
        isFormChanged = true;
        solutionModel.IsImageDeleted = true;
        if (isEdit && !canEditMainImage)
        {
            MainImagePath = string.Empty;
            ThumbImagePath = string.Empty;
            canEditMainImage = true;
        }
        else
        {
            mainImage = new();
        }
        selectedFile = $"ANA GÖRSEL SEÇİNİZ";
        uploadIcon = "upload";
    }

   

    private void SetDefaults()
    {
        mainImage = new();
        selectedFile = $"ANA GÖRSEL SEÇİNİZ";
        uploadIcon = "upload";
        canEditMainImage = false;
        canEditMainImage = false;
        solutionModel.IsImageDeleted = false;
    }

    private void OnInvalidSubmit(FormInvalidSubmitEventArgs args)
    {
        ToastService.ShowError("Eksik veya hatalı alanlar mevcut!");
    }

    private async Task HandleSubmit(Guid? id = default)
    {
        base.ShowLoader();
        try
        {
            //await Task.Yield();
            if (isEdit)
            {
                if (!isFormChanged)
                {
                    base.HideLoader();
                    ToastService.ShowWarning("Formda herhangi bir değişiklik yapılmadı !");
                    return;
                }
                if (id == null || id == Guid.Empty)
                {
                    base.HideLoader();
                    ToastService.ShowError("İlgili proje bulunamadı. Lütfen sayfayı yenileyip tekrar deneyiniz.");
                    return;
                }
            }

            using var formData = new MultipartFormDataContent();

            formData.Add(new StringContent(solutionModel.Title ?? ""), "Title");
            formData.Add(new StringContent(solutionModel.SubTitle ?? ""), "SubTitle");
            formData.Add(new StringContent(solutionModel.IsImageDeleted.ToString() ?? "false"), "IsImageDeleted");
            formData.Add(new StringContent(solutionModel.SolutionType.ToString() ?? ""), "SolutionType");

            if (mainImage.FileContent != null)
            {
                var fileContent = new ByteArrayContent(mainImage.FileContent);
                fileContent.Headers.ContentDisposition = new System.Net.Http.Headers.ContentDispositionHeaderValue("form-data")
                    {
                        Name = "\"MainImage\"",
                        FileName = $"\"{mainImage.FileName}\""
                    };
                fileContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue(mainImage.ContentType);
                formData.Add(fileContent, "MainImage", mainImage.FileName);
            }

            if (isEdit)
            {
                var response = await SolutionService.UpdateSolutionAsync(solutionId, formData);

                if (!response.IsSuccessStatusCode)
                {
                    base.HideLoader();
                    SetDefaults();

                    string errorMessage = response.ReasonPhrase!;
                    ToastService.ShowError(errorMessage);
                    return;
                }
                else
                {
                    DialogService.Close(true);
                    base.HideLoader();
                }
            }
            else
            {
                var response = await SolutionService.CreateSolutionAsync(formData);

                if (!response.IsSuccessStatusCode)
                {
                    base.HideLoader();
                    SetDefaults();

                    string errorMessage = response.ReasonPhrase!;
                    ToastService.ShowError(errorMessage);
                    return;
                }
                else
                {
                    DialogService.Close(true);
                    base.HideLoader();
                }
            }
        }
        catch (Exception ex)
        {
            base.HideLoader();
            SetDefaults();
            ToastService.ShowError(ex.Message);
        }
    }
}
